{% extends "base.html" %}

{% block title %}{{ course.title }} - EdTech IA & Cyber{% endblock %}

{% block content %}
<div class="container">
    <!-- Cabeçalho do curso -->
    <div class="row mb-4">
        <div class="col-md-8">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('courses.dashboard') }}">Dashboard</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('courses.course_list') }}">Cursos</a></li>
                    <li class="breadcrumb-item active" aria-current="page">{{ course.title }}</li>
                </ol>
            </nav>
            
            <span class="badge bg-primary mb-2">{{ course.category }}</span>
            <span class="badge bg-secondary mb-2">{{ course.level }}</span>
            
            <h1 class="mb-3">{{ course.title }}</h1>
            
            {% if is_enrolled %}
            <div class="alert alert-success">
                <strong>Você está matriculado neste curso</strong>
                <div class="mt-2">
                    <div class="progress">
                        <div class="progress-bar" role="progressbar" style="width: {{ progress }}%;" aria-valuenow="{{ progress }}" aria-valuemin="0" aria-valuemax="100">{{ progress }}%</div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-body text-center">
                    {% if not is_enrolled %}
                    <p class="mb-2">Matricule-se para começar a aprender</p>
                    <form action="{{ url_for('courses.enroll', course_id=course.id) }}" method="POST">
                        <button type="submit" class="btn btn-primary btn-lg w-100">
                            <i class="fas fa-graduation-cap"></i> Matricular-se
                        </button>
                    </form>
                    {% else %}
                    <a href="#modules" class="btn btn-success btn-lg w-100">
                        <i class="fas fa-play-circle"></i> Continuar Aprendendo
                    </a>
                    {% endif %}
                    
                    <hr>
                    
                    <div class="course-stats">
                        <div class="row">
                            <div class="col-6 text-center">
                                <div class="stat-value"><i class="fas fa-clock"></i></div>
                                <div class="stat-label">{{ course.duration_hours or '?' }} horas</div>
                            </div>
                            <div class="col-6 text-center">
                                <div class="stat-value"><i class="fas fa-users"></i></div>
                                <div class="stat-label">{{ course.enrollment_count }} alunos</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Detalhes do curso -->
    <div class="row">
        <div class="col-md-8">
            <!-- Imagem do curso -->
            <div class="course-image mb-4">
                {% if course.thumbnail %}
                <img src="{{ course.thumbnail }}" class="img-fluid rounded" alt="{{ course.title }}">
                {% else %}
                <img src="{{ url_for('static', filename='img/course-placeholder.jpg') }}" class="img-fluid rounded" alt="{{ course.title }}">
                {% endif %}
            </div>
            
            <!-- Descrição do curso -->
            <div class="card mb-4">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-info-circle"></i> Sobre este curso</h3>
                </div>
                <div class="card-body">
                    <p>{{ course.description | safe }}</p>
                    
                    {% if course.tags %}
                    <div class="mt-3">
                        <strong>Tags:</strong>
                        {% for tag in course.tags %}
                        <span class="badge bg-light text-dark me-1">{{ tag }}</span>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Módulos do curso -->
            <div class="card" id="modules">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-list"></i> Conteúdo do Curso</h3>
                </div>
                <div class="card-body">
                    <div class="accordion" id="courseModules">
                        {% for module in modules %}
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="heading{{ module.id }}">
                                <button class="accordion-button {% if not loop.first %}collapsed{% endif %}" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ module.id }}" aria-expanded="{{ 'true' if loop.first else 'false' }}" aria-controls="collapse{{ module.id }}">
                                    {{ module.order }}. {{ module.title }}
                                </button>
                            </h2>
                            <div id="collapse{{ module.id }}" class="accordion-collapse collapse {% if loop.first %}show{% endif %}" aria-labelledby="heading{{ module.id }}" data-bs-parent="#courseModules">
                                <div class="accordion-body">
                                    {% if module.description %}
                                    <p>{{ module.description }}</p>
                                    <hr>
                                    {% endif %}
                                    
                                    <div class="list-group">
                                        {% for lesson in module.lessons %}
                                        <a href="{{ url_for('courses.lesson_view', lesson_id=lesson.id) if is_enrolled else '#' }}" class="list-group-item list-group-item-action {% if not is_enrolled %}disabled{% endif %}">
                                            <div class="d-flex w-100 justify-content-between">
                                                <h6 class="mb-1">{{ lesson.order }}. {{ lesson.title }}</h6>
                                                <small>
                                                    {% if lesson.duration_minutes %}
                                                    <span class="badge bg-light text-dark">{{ lesson.duration_minutes }} min</span>
                                                    {% endif %}
                                                    
                                                    {% if lesson.lesson_type == 'video' %}
                                                    <span class="badge bg-danger"><i class="fas fa-video"></i> Vídeo</span>
                                                    {% elif lesson.lesson_type == 'interactive' %}
                                                    <span class="badge bg-warning text-dark"><i class="fas fa-hands"></i> Interativo</span>
                                                    {% else %}
                                                    <span class="badge bg-info"><i class="fas fa-file-alt"></i> Texto</span>
                                                    {% endif %}
                                                    
                                                    {% if lesson.has_quiz %}
                                                    <span class="badge bg-success"><i class="fas fa-question-circle"></i> Quiz</span>
                                                    {% endif %}
                                                </small>
                                            </div>
                                        </a>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <!-- Instrutor -->
            <div class="card mb-4">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-chalkboard-teacher"></i> Instrutor</h3>
                </div>
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                        <div class="flex-shrink-0">
                            {% if course.created_by.profile_pic %}
                            <img src="{{ course.created_by.profile_pic }}" class="rounded-circle" width="60" height="60" alt="{{ course.created_by.get_full_name() }}">
                            {% else %}
                            <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                                <span style="font-size: 24px;">{{ course.created_by.first_name[0] }}{{ course.created_by.last_name[0] }}</span>
                            </div>
                            {% endif %}
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h5 class="mb-0">{{ course.created_by.get_full_name() }}</h5>
                            <p class="text-muted mb-0">{{ course.created_by.job_title }}</p>
                        </div>
                    </div>
                    
                    {% if course.created_by.bio %}
                    <p>{{ course.created_by.bio }}</p>
                    {% endif %}
                </div>
            </div>
            
            <!-- Pré-requisitos -->
            {% if course.prerequisite_courses %}
            <div class="card mb-4">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-clipboard-list"></i> Pré-requisitos</h3>
                </div>
                <div class="card-body">
                    <ul class="list-group">
                        {% for prereq_id in course.prerequisite_courses %}
                        {% set prereq = get_course(prereq_id) %}
                        {% if prereq %}
                        <li class="list-group-item">
                            <a href="{{ url_for('courses.course_detail', slug=prereq.slug) }}">{{ prereq.title }}</a>
                        </li>
                        {% endif %}
                        {% endfor %}
                    </ul>
                </div>
            </div>
            {% endif %}
            
            <!-- Visão geral gerada por IA -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h3 class="card-title mb-0"><i class="fas fa-brain"></i> Visão Geral</h3>
                    <button class="btn btn-sm btn-outline-primary" id="generateOverview">
                        <i class="fas fa-sync-alt"></i> Gerar
                    </button>
                </div>
                <div class="card-body">
                    <div id="aiOverview">
                        <p class="text-center text-muted">
                            <i class="fas fa-info-circle"></i> Clique em "Gerar" para criar uma visão geral do curso usando IA.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const overviewBtn = document.getElementById('generateOverview');
        const overviewContainer = document.getElementById('aiOverview');
        
        overviewBtn.addEventListener('click', function() {
            // Altera o estado do botão
            overviewBtn.disabled = true;
            overviewBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Gerando...';
            
            // Atualiza o container
            overviewContainer.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Gerando visão geral com IA...</div>';
            
            // Faz a requisição para a API
            fetch('{{ url_for("courses.course_overview", course_id=course.id) }}')
                .then(response => response.json())
                .then(data => {
                    let html = '';
                    
                    // Resumo
                    html += `<p>${data.summary}</p>`;
                    
                    // Pontos-chave
                    if (data.key_points && data.key_points.length > 0) {
                        html += '<h5>Pontos-chave</h5>';
                        html += '<ul>';
                        data.key_points.forEach(point => {
                            html += `<li>${point}</li>`;
                        });
                        html += '</ul>';
                    }
                    
                    // Resultados de aprendizagem
                    if (data.learning_outcomes && data.learning_outcomes.length > 0) {
                        html += '<h5>Resultados de Aprendizagem</h5>';
                        html += '<ul>';
                        data.learning_outcomes.forEach(outcome => {
                            html += `<li>${outcome}</li>`;
                        });
                        html += '</ul>';
                    }
                    
                    // Atualiza o container
                    overviewContainer.innerHTML = html;
                })
                .catch(error => {
                    console.error('Erro ao gerar visão geral:', error);
                    overviewContainer.innerHTML = '<div class="alert alert-danger">Erro ao gerar visão geral. Tente novamente mais tarde.</div>';
                })
                .finally(() => {
                    // Restaura o estado do botão
                    overviewBtn.disabled = false;
                    overviewBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Gerar';
                });
        });
    });
</script>
{% endblock %}